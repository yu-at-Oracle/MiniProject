# 課題1-2と同じCentOS7のdocker container内から実行
https://www.graalvm.org/docs/getting-started/
Getting Started

0. バージョン確認
$ java -version
java version "1.8.0_172"
Java(TM) SE Runtime Environment (build 1.8.0_172-b11)
GraalVM 1.0.0-rc5 (build 25.71-b01-internal-jvmci-0.46, mixed mode)

$ node -v
v8.11.1

$ lli --version
Graal llvm 6.0.0 (GraalVM EE Native 1.0.0-rc5)

1. Running Java
HelloWorld.java:

public class HelloWorld {
  public static void main(String[] args) {
    System.out.println("Hello, World!");
  }
}

$ javac HelloWorld.java
$ java HelloWorld
Hello World!

2. Running LLVM interpreter
hello.c:

#include <stdio.h>
int main() {
    printf("Hello from GraalVM!\n");
    return 0;
}

$ clang -c -O1 -emit-llvm hello.c
$ lli hello.bc
Hello from GraalVM!

3. Running R
$ R
R version 3.4.0 (FastR)
Copyright (c) 2013-18, Oracle and/or its affiliates
Copyright (c) 1995-2017, The R Core Team
Copyright (c) 2017 The R Foundation for Statistical Computing
Copyright (c) 2012-4 Purdue University
Copyright (c) 1997-2002, Makoto Matsumoto and Takuji Nishimura
All rights reserved.

FastR is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information.

Type 'q()' to quit R.
> 1 + 1
[1] 2

4. Running Python
ドキュメント通りに実行すると、以下のようなエラーとなる。

$ graalpython
ERROR: java.lang.NullPointerException
org.graalvm.polyglot.PolyglotException: java.lang.NullPointerException
        at com.oracle.graal.python.builtins.Python3Core.getScriptPath(Python3Core.java:487)
        at com.oracle.graal.python.builtins.Python3Core.initializeSysPath(Python3Core.java:466)
        at com.oracle.graal.python.builtins.Python3Core.createSysModule(Python3Core.java:459)
        at com.oracle.graal.python.runtime.PythonContext.initialize(PythonContext.java:166)
        at com.oracle.graal.python.PythonLanguage.patchContext(PythonLanguage.java:114)
        at com.oracle.graal.python.PythonLanguage.patchContext(PythonLanguage.java:73)
        at com.oracle.truffle.api.TruffleLanguage$LanguageImpl.patchEnvContext(TruffleLanguage.java:2471)
        at com.oracle.truffle.api.vm.PolyglotLanguageContext.patch(PolyglotLanguageContext.java:401)
        at com.oracle.truffle.api.vm.PolyglotContextImpl.patch(PolyglotContextImpl.java:1005)
        at com.oracle.truffle.api.vm.PolyglotEngineImpl.loadPreinitializedContext(PolyglotEngineImpl.java:1047)
        at com.oracle.truffle.api.vm.PolyglotEngineImpl.createContext(PolyglotEngineImpl.java:1020)
        at org.graalvm.polyglot.Context$Builder.build(Context.java:1014)
        at com.oracle.graal.python.shell.GraalPythonMain.launch(GraalPythonMain.java:177)
        at org.graalvm.launcher.AbstractLanguageLauncher.launch(AbstractLanguageLauncher.java:107)
        at org.graalvm.launcher.AbstractLanguageLauncher.launch(AbstractLanguageLauncher.java:54)
        at com.oracle.graal.python.shell.GraalPythonMain.main(GraalPythonMain.java:56)
        at com.oracle.svm.core.JavaMainWrapper.run(JavaMainWrapper.java:177)
Original Internal Error:
java.lang.NullPointerException
        at com.oracle.graal.python.builtins.Python3Core.getScriptPath(Python3Core.java:487)
        at com.oracle.graal.python.builtins.Python3Core.initializeSysPath(Python3Core.java:466)
        at com.oracle.graal.python.builtins.Python3Core.createSysModule(Python3Core.java:459)
        at com.oracle.graal.python.runtime.PythonContext.initialize(PythonContext.java:166)
        at com.oracle.graal.python.PythonLanguage.patchContext(PythonLanguage.java:114)
        at com.oracle.graal.python.PythonLanguage.patchContext(PythonLanguage.java:73)
        at com.oracle.truffle.api.TruffleLanguage$LanguageImpl.patchEnvContext(TruffleLanguage.java:2471)
        at com.oracle.truffle.api.vm.PolyglotLanguageContext.patch(PolyglotLanguageContext.java:401)
        at com.oracle.truffle.api.vm.PolyglotContextImpl.patch(PolyglotContextImpl.java:1005)
        at com.oracle.truffle.api.vm.PolyglotEngineImpl.loadPreinitializedContext(PolyglotEngineImpl.java:1047)
        at com.oracle.truffle.api.vm.PolyglotEngineImpl.createContext(PolyglotEngineImpl.java:1020)
        at org.graalvm.polyglot.Context$Builder.build(Context.java:1014)
        at com.oracle.graal.python.shell.GraalPythonMain.launch(GraalPythonMain.java:177)
        at org.graalvm.launcher.AbstractLanguageLauncher.launch(AbstractLanguageLauncher.java:107)
        at org.graalvm.launcher.AbstractLanguageLauncher.launch(AbstractLanguageLauncher.java:54)
        at com.oracle.graal.python.shell.GraalPythonMain.main(GraalPythonMain.java:56)
        at com.oracle.svm.core.JavaMainWrapper.run(JavaMainWrapper.java:177)
Caused by: Attached Guest Language Frames (0)

5. Combine Languages
https://www.graalvm.org/docs/reference-manual/polyglot/
Java & C
Polyglot.java
import java.io.*;
import org.graalvm.polyglot.*;

class Polyglot {
    public static void main(String[] args) throws IOException {
        Context polyglot = Context.newBuilder().
                                       allowAllAccess(true).build();
        File file = new File("polyglot.bc");
        Source source = Source.newBuilder("llvm", file).build();
        Value cpart = polyglot.eval(source);
        cpart.getMember("main").execute();
    }
}

$ javac Polyglot.java
$ java Polyglot
42

C & Python
polyglot.c
#include <stdio.h>
#include <polyglot.h>

int main() {
    void *array = polyglot_eval("python", "[1,2,42,4]");
    int element = polyglot_as_i32(polyglot_get_array_element(array, 2));
    printf("%d\n", element);
    return element;
}

$ clang -g -O1 -c  -emit-llvm -I$GRAALVM_HOME/jre/languages/llvm polyglot.c
$ lli --polyglot --jvm polyglot.bc
42

6. Native images
ドキュメント通りに実行したが、native-image作成の箇所でエラーとなりました。

$ javac HelloWorld.java
$ native-image HelloWorld
Build on Server(pid: 470, port: 36075)
java.lang.NullPointerException
        at com.oracle.svm.hosted.ImageClassLoader.toClassPathEntries(ImageClassLoader.java:186)
        at java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:267)
        at java.util.HashMap$KeySpliterator.forEachRemaining(HashMap.java:1553)
        at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:481)
        at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:471)
        at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:545)
        at java.util.stream.AbstractPipeline.evaluateToArrayNode(AbstractPipeline.java:260)
        at java.util.stream.ReferencePipeline.toArray(ReferencePipeline.java:438)
        at com.oracle.svm.hosted.NativeImageGeneratorRunner.verifyClassPathAndConvertToURLs(NativeImageGeneratorRunner.java:153)
        at com.oracle.svm.hosted.NativeImageGeneratorRunner.installNativeImageClassLoader(NativeImageGeneratorRunner.java:111)
        at com.oracle.svm.hosted.server.NativeImageBuildServer.executeCompilation(NativeImageBuildServer.java:386)
        at com.oracle.svm.hosted.server.NativeImageBuildServer.lambda$processCommand$8(NativeImageBuildServer.java:327)
        at com.oracle.svm.hosted.server.NativeImageBuildServer.withJVMContext(NativeImageBuildServer.java:408)
        at com.oracle.svm.hosted.server.NativeImageBuildServer.processCommand(NativeImageBuildServer.java:324)
        at com.oracle.svm.hosted.server.NativeImageBuildServer.processRequest(NativeImageBuildServer.java:268)
        at com.oracle.svm.hosted.server.NativeImageBuildServer.lambda$serve$7(NativeImageBuildServer.java:228)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.Thread.run(Thread.java:748)
Error: Processing image build request failed

